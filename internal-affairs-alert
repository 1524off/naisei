# alert.py
import os
import datetime
from zoneinfo import ZoneInfo
import discord
from discord.ext import commands

# === è¨­å®š ===
TOKEN = os.environ["DISCORD_BOT_TOKEN"]
CHANNEL_ID = int(os.environ["DISCORD_CHANNEL_ID"])

ROLES = {
    1: {"name": "NFG", "role_id": 1423254785938948226, "lang": "jp"},
    2: {"name": "1UP", "role_id": 1423302704972824576, "lang": "en"},
    3: {"name": "HAP", "role_id": 1423254452407894118, "lang": "jp"},
    4: {"name": "JST", "role_id": 1423254682498895964, "lang": "jp"},
    5: {"name": "N9Q", "role_id": None, "lang": "jp"},
    6: {"name": "MKW", "role_id": None, "lang": "jp"},
    7: {"name": "SBZ", "role_id": None, "lang": "jp"},
    8: {"name": "BM1", "role_id": None, "lang": "jp"},
    9: {"name": "Free Day", "role_id": None, "lang": "free"},
    0: {"name": "Free Day", "role_id": None, "lang": "free"},
}

HOPE_ROLE_ID = 1424450874649870427  # ã€Œå†…æ”¿éƒ¨é•·é€šçŸ¥ã€ãƒ­ãƒ¼ãƒ«
tz = ZoneInfo("Asia/Tokyo")

intents = discord.Intents.default()
intents.members = True
bot = commands.Bot(command_prefix="!", intents=intents)


@bot.event
async def on_ready():
    today = datetime.datetime.now(tz).date()
    day_digit = int(str(today.day)[-1])
    info = ROLES.get(day_digit)
    channel = bot.get_channel(CHANNEL_ID)
    hope_role = channel.guild.get_role(HOPE_ROLE_ID)

    mm = f"{today.month:02d}"
    dd = f"{today.day:02d}"

    if info["role_id"]:
        role_today = channel.guild.get_role(info["role_id"])
        members_to_notify = [
            m for m in channel.guild.members
            if hope_role in m.roles and role_today in m.roles
        ]
    else:
        # ãƒ•ãƒªãƒ¼ï¼ˆ9ãƒ»0ã®æ—¥ï¼‰ã¯å¸Œæœ›è€…å…¨å“¡é€šçŸ¥
        members_to_notify = [
            m for m in channel.guild.members if hope_role in m.roles
        ]

    mentions = " ".join([m.mention for m in members_to_notify])
    alliance = info["name"]
    lang = info["lang"]

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
    if lang == "en":
        title = "ğŸ“¢ Internal Affairs Alert"
        desc = f"ğŸ›ï¸ **Internal Affairs: {alliance}**\nğŸ“… **Today: {mm}/{dd}**"
        note = "âœ‰ï¸ Notification Target: Internal Affairs + Alliance Role"
    elif lang == "free":
        title = "ğŸ“¢ å†…æ”¿éƒ¨é•·ã‚¢ãƒ©ãƒ¼ãƒˆ"
        desc = f"ğŸ“… **ä»Šæ—¥ã¯ {mm}/{dd}**\nğŸ›ï¸ **ç›Ÿä¸»ä¼šãƒ•ãƒªãƒ¼ã§ã™ Today is Free Day!**"
        note = "âœ‰ï¸ é€šçŸ¥å¯¾è±¡ï¼šå¸Œæœ›è€…å…¨å“¡"
    else:
        title = "ğŸ“¢ å†…æ”¿éƒ¨é•·ã‚¢ãƒ©ãƒ¼ãƒˆ"
        desc = f"ğŸ›ï¸ **æ‹…å½“ï¼š{alliance} ã•ã‚“**\nğŸ“… **ä»Šæ—¥ã¯ {mm}/{dd}**"
        note = "âœ‰ï¸ é€šçŸ¥å¯¾è±¡ï¼šå†…æ”¿éƒ¨é•·é€šçŸ¥ãƒ­ãƒ¼ãƒ« ï¼‹ æ‹…å½“åŒç›Ÿãƒ­ãƒ¼ãƒ«"

    embed = discord.Embed(title=title, description=desc, color=0x9EC3FF)
    embed.add_field(name="â° æŠ•ç¨¿æ™‚é–“", value="æ¯æœ 9:00ï¼ˆJSTï¼‰", inline=True)
    embed.add_field(name="âœ‰ï¸ é€šçŸ¥å¯¾è±¡", value=note, inline=True)
    embed.set_footer(text="è‡ªå‹•é€ä¿¡ by GitHub Actions ğŸ¤–")

    await channel.send(content=mentions, embed=embed)
    await bot.close()


bot.run(TOKEN)
