# alert.py
import os
import datetime
from zoneinfo import ZoneInfo
import discord
from discord.ext import commands

# === 設定 ===
TOKEN = os.environ["DISCORD_BOT_TOKEN"]
CHANNEL_ID = int(os.environ["DISCORD_CHANNEL_ID"])

ROLES = {
    1: {"name": "NFG", "role_id": 1423254785938948226, "lang": "jp"},
    2: {"name": "1UP", "role_id": 1423302704972824576, "lang": "en"},
    3: {"name": "HAP", "role_id": 1423254452407894118, "lang": "jp"},
    4: {"name": "JST", "role_id": 1423254682498895964, "lang": "jp"},
    5: {"name": "N9Q", "role_id": None, "lang": "jp"},
    6: {"name": "MKW", "role_id": None, "lang": "jp"},
    7: {"name": "SBZ", "role_id": None, "lang": "jp"},
    8: {"name": "BM1", "role_id": None, "lang": "jp"},
    9: {"name": "Free Day", "role_id": None, "lang": "free"},
    0: {"name": "Free Day", "role_id": None, "lang": "free"},
}

HOPE_ROLE_ID = 1424450874649870427  # 「内政部長通知」ロール
tz = ZoneInfo("Asia/Tokyo")

intents = discord.Intents.default()
intents.members = True
bot = commands.Bot(command_prefix="!", intents=intents)


@bot.event
async def on_ready():
    today = datetime.datetime.now(tz).date()
    day_digit = int(str(today.day)[-1])
    info = ROLES.get(day_digit)
    channel = bot.get_channel(CHANNEL_ID)
    hope_role = channel.guild.get_role(HOPE_ROLE_ID)

    mm = f"{today.month:02d}"
    dd = f"{today.day:02d}"

    if info["role_id"]:
        role_today = channel.guild.get_role(info["role_id"])
        members_to_notify = [
            m for m in channel.guild.members
            if hope_role in m.roles and role_today in m.roles
        ]
    else:
        # フリー（9・0の日）は希望者全員通知
        members_to_notify = [
            m for m in channel.guild.members if hope_role in m.roles
        ]

    mentions = " ".join([m.mention for m in members_to_notify])
    alliance = info["name"]
    lang = info["lang"]

    # メッセージ切り替え
    if lang == "en":
        title = "📢 Internal Affairs Alert"
        desc = f"🏛️ **Internal Affairs: {alliance}**\n📅 **Today: {mm}/{dd}**"
        note = "✉️ Notification Target: Internal Affairs + Alliance Role"
    elif lang == "free":
        title = "📢 内政部長アラート"
        desc = f"📅 **今日は {mm}/{dd}**\n🏛️ **盟主会フリーです Today is Free Day!**"
        note = "✉️ 通知対象：希望者全員"
    else:
        title = "📢 内政部長アラート"
        desc = f"🏛️ **担当：{alliance} さん**\n📅 **今日は {mm}/{dd}**"
        note = "✉️ 通知対象：内政部長通知ロール ＋ 担当同盟ロール"

    embed = discord.Embed(title=title, description=desc, color=0x9EC3FF)
    embed.add_field(name="⏰ 投稿時間", value="毎朝 9:00（JST）", inline=True)
    embed.add_field(name="✉️ 通知対象", value=note, inline=True)
    embed.set_footer(text="自動送信 by GitHub Actions 🤖")

    await channel.send(content=mentions, embed=embed)
    await bot.close()


bot.run(TOKEN)
